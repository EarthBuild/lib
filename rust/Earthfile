VERSION 0.7

# CARGO caches the cargo command "cargo $cargo_args"
# Arguments:
#   - args (required): Cargo subcommand and its arguments
CARGO:
    COMMAND
    ARG --required args
    ARG cargo_home=$(echo $CARGO_HOME)
    ARG output_name=$(echo "$cargo_args" | head -n1 | cut -d " " -f1)
    COPY +get-stoml/stoml /tmp/stoml
    ARG source_libs=$(find . -name Cargo.toml -exec bash -c '/tmp/stoml {} package.name; printf "\n"' \\;)
    CACHE ./target/
    ARG fingerprint_folders = $(find target -name .fingerprint)
    RUN for fingerprint_folder in $fingerprint_folders; do \
          cd $fingerprint_folder; \
          for source_lib in $source_libs; do \
            find . -maxdepth 1 -regex "\./$source_lib-[^-]+" -exec rm -rf {} \; ;\
          done \
        done
    RUN --mount=type=cache,sharing=shared,target=$cargo_home/registry \
        --mount=type=cache,sharing=shared,target=$cargo_home/git \
        cargo $args

get-stoml:
    FROM alpine:3.18.3
    RUN wget -O stoml https://github.com/freshautomations/stoml/releases/download/v0.7.1/stoml_linux_amd64; \
       chmod +x stoml
    SAVE ARTIFACT ./stoml stoml