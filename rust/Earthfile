VERSION --global-cache 0.7

# CARGO caches the cargo command "cargo $cargo_args"
# Arguments:
#   - args (required): Cargo subcommand and its arguments
#   - output: Regex to match the files within the target folder to be copied from the cache to the caller filesystem (image layers).
#     Use this argument when you want to SAVE an ARTIFACT from the target folder (mounted cache), always trying to minimize the total size of the copied fileset.
#     For example --output="release/[^\./]+" would keep all the files in /target/release that don't have any extension
CARGO:
    COMMAND
    ARG --required args
    ARG output
    DO +REMOVE_SOURCE_FINGERPRINTS
    RUN --mount=type=cache,mode=0777,sharing=shared,target=$CARGO_HOME/registry \
        --mount=type=cache,mode=0777,sharing=shared,target=$CARGO_HOME/git \
        --mount=type=cache,mode=0777,target=target \
        cargo $args;
    IF [ "$output" != "" ]
      DO +COPY_FROM_TARGET_CACHE --regex=$output
    END

# COPY_FROM_TARGET_CACHE copies the files matching the regex from the target cache to the caller filesystem (image layers).
COPY_FROM_TARGET_CACHE:
    COMMAND
    ARG regex
    RUN --no-cache --mount=type=cache,mode=0777,target=target \
        mkdir earthly_lib_rust_temp; \
        cd target; \
        find . -regextype posix-egrep -regex "./$regex" -exec cp --parents \{\} ../earthly_lib_rust_temp \; ; \
        cd ..; \
        echo "Copied output: $(du -hs earthly_lib_rust_temp | awk '{print $1}')";
    RUN mkdir -p target; \
        mv earthly_lib_rust_temp/* target;

# REMOVE_SOURCE_FINGERPRINTS removes the Cargo fingerprint folders of the source packages.
# This guarantees Cargo compiles the packages when COPY commands of the source folders have a static timestamp (see --keep-ts)
REMOVE_SOURCE_FINGERPRINTS:
    COMMAND
    COPY +get-stoml/stoml /tmp/stoml
    ARG source_libs=$(find . -name Cargo.toml -exec bash -c '/tmp/stoml {} package.name; printf "\n"' \\;)
    RUN --mount=type=cache,mode=0777,sharing=shared,target=target \
      find target -name .fingerprint; \
      fingerprint_folders=$(find target -name .fingerprint) ; \
      for fingerprint_folder in $fingerprint_folders; do \
        cd $fingerprint_folder; \
        for source_lib in $source_libs; do \
          find . -maxdepth 1 -regex "\./$source_lib-[^-]+" -exec rm -rf {} \; ;\
        done \
      done

# get-stoml gets the portable stoml binary
get-stoml:
    FROM alpine:3.18.3
    RUN wget -O stoml https://github.com/freshautomations/stoml/releases/download/v0.7.1/stoml_linux_amd64; \
       chmod +x stoml
    SAVE ARTIFACT ./stoml stoml
